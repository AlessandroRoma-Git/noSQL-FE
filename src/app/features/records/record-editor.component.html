<div class="container mx-auto p-4 max-w-6xl">
  <!-- Titolo della Pagina -->
  <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
    <div>
      @if (entityDefinition) {
        <h1 class="text-3xl font-bold text-[rgb(var(--color-primary))]">
          {{ isEditMode ? i18nService.translate('RECORDS.EDIT_TITLE') : i18nService.translate('RECORDS.CREATE_TITLE') }} {{ entityDefinition.label }}
        </h1>
      }
      <p class="text-gray-500 text-sm mt-1">{{ i18nService.translate('RECORDS.MANAGE_DATA') }} {{ entityKey }}</p>
    </div>
    
    <a [routerLink]="['/records', entityKey]" class="button-secondary self-start">
      &larr; {{ i18nService.translate('COMMON.BACK_TO_LIST') }}
    </a>
  </div>

  <!-- Menu a Schede (Tabs) -->
  @if (isEditMode && entityDefinition && entityDefinition.historyEnabled) {
    <div class="flex border-b border-white/5 mb-6">
      <button 
        (click)="setTab('data')"
        class="px-6 py-3 font-medium text-sm transition-colors border-b-2"
        [class.border-[rgb(var(--color-primary))]]="activeTab === 'data'"
        [class.text-[rgb(var(--color-primary))]]="activeTab === 'data'"
        [class.border-transparent]="activeTab !== 'data'"
        [class.text-gray-400]="activeTab !== 'data'">
        {{ i18nService.translate('RECORDS.CURRENT_DATA') }}
      </button>
      <button 
        (click)="setTab('history')"
        class="px-6 py-3 font-medium text-sm transition-colors border-b-2"
        [class.border-[rgb(var(--color-primary))]]="activeTab === 'history'"
        [class.text-[rgb(var(--color-primary))]]="activeTab === 'history'"
        [class.border-transparent]="activeTab !== 'history'"
        [class.text-gray-400]="activeTab !== 'history'">
        {{ i18nService.translate('RECORDS.HISTORY') }}
      </button>
    </div>
  }

  <!-- CONTENUTO SCHEDA: DATI -->
  @if (activeTab === 'data') {
    @if (entityDefinition) {
      <form [formGroup]="editorForm" (ngSubmit)="onSubmit()" class="card-soft p-8">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          
          @for (field of entityDefinition.fields; track field.name) {
            <div class="flex flex-col">
              <label [for]="field.name" class="label flex items-center gap-1">
                {{ field.name }}
                @if (field.required) { <span class="text-red-500">*</span> }
              </label>

              @switch (field.type) {
                @case ('STRING') {
                  <input [id]="field.name" [formControlName]="field.name" type="text" class="input" 
                         [placeholder]="field.name"
                         [class.ring-2]="editorForm.get(field.name)?.invalid && editorForm.get(field.name)?.touched"
                         [class.ring-red-500]="editorForm.get(field.name)?.invalid && editorForm.get(field.name)?.touched">
                }
                @case ('EMAIL') {
                  <input [id]="field.name" [formControlName]="field.name" type="email" class="input" 
                         placeholder="esempio@mail.com"
                         [class.ring-2]="editorForm.get(field.name)?.invalid && editorForm.get(field.name)?.touched"
                         [class.ring-red-500]="editorForm.get(field.name)?.invalid && editorForm.get(field.name)?.touched">
                }
                @case ('NUMBER') {
                  <input [id]="field.name" [formControlName]="field.name" type="number" class="input"
                         [class.ring-2]="editorForm.get(field.name)?.invalid && editorForm.get(field.name)?.touched"
                         [class.ring-red-500]="editorForm.get(field.name)?.invalid && editorForm.get(field.name)?.touched">
                }
                @case ('BOOLEAN') {
                  <div class="flex items-center h-12 mt-1">
                    <input [id]="field.name" [formControlName]="field.name" type="checkbox" 
                           class="h-6 w-6 rounded-xl border-none bg-white/5 text-[rgb(var(--color-primary))] focus:ring-offset-0 focus:ring-[rgb(var(--color-primary))] cursor-pointer">
                    <span class="ml-3 text-sm text-gray-400">{{ i18nService.translate('COMMON.ACTIVE') }}</span>
                  </div>
                }
                @case ('DATE') {
                  <input [id]="field.name" [formControlName]="field.name" type="datetime-local" class="input"
                         [class.ring-2]="editorForm.get(field.name)?.invalid && editorForm.get(field.name)?.touched"
                         [class.ring-red-500]="editorForm.get(field.name)?.invalid && editorForm.get(field.name)?.touched">
                }
                @case ('ENUM') {
                  <select [id]="field.name" [formControlName]="field.name" class="input"
                          [class.ring-2]="editorForm.get(field.name)?.invalid && editorForm.get(field.name)?.touched"
                          [class.ring-red-500]="editorForm.get(field.name)?.invalid && editorForm.get(field.name)?.touched">
                    <option [ngValue]="null">{{ i18nService.translate('RECORDS.SELECT_VALUE') }}</option>
                    @for (enumValue of field.enumValues; track enumValue) {
                      <option [value]="enumValue">{{ enumValue }}</option>
                    }
                  </select>
                }
                @case ('REFERENCE') {
                  <app-reference-search [formControlName]="field.name" [entityKey]="field.referenceEntityKey!"></app-reference-search>
                }
              }

              <!-- Messaggi di Errore -->
              <div class="h-5 mt-1">
                @if (hasError(field.name, 'required')) {
                  <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">{{ i18nService.translate('RECORDS.REQUIRED_FIELD') }}</span>
                }
                @if (hasError(field.name, 'email')) {
                  <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">{{ i18nService.translate('RECORDS.INVALID_EMAIL') }}</span>
                }
                @if (hasError(field.name, 'maxlength')) {
                  <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">{{ i18nService.translate('RECORDS.TOO_LONG').replace('{{max}}', (field.maxLen || 0).toString()) }}</span>
                }
                @if (hasError(field.name, 'min')) {
                  <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">{{ i18nService.translate('RECORDS.MIN_VALUE').replace('{{min}}', (field.min || 0).toString()) }}</span>
                }
                @if (hasError(field.name, 'max')) {
                  <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">{{ i18nService.translate('RECORDS.MAX_VALUE').replace('{{max}}', (field.max || 0).toString()) }}</span>
                }
                @if (hasError(field.name, 'pattern')) {
                  <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">{{ i18nService.translate('RECORDS.INVALID_FORMAT') }}</span>
                }
              </div>
            </div>
          }
        </div>

        <!-- Bottoni in fondo -->
        <div class="flex justify-end space-x-4 border-t border-white/5 pt-8 mt-8">
          <a [routerLink]="['/records', entityKey]" class="button-secondary px-8">{{ i18nService.translate('COMMON.CANCEL_SHORT') }}</a>
          <button type="submit" [disabled]="editorForm.invalid" class="button-primary px-10">
            {{ isEditMode ? i18nService.translate('COMMON.SAVE') : i18nService.translate('COMMON.CREATE') }}
          </button>
        </div>
      </form>
    } @else {
      <div class="flex flex-col items-center justify-center p-20 card-soft animate-pulse">
        <div class="w-12 h-12 rounded-full border-4 border-white/10 border-t-[rgb(var(--color-primary))] animate-spin mb-4"></div>
        <p class="text-gray-500 font-black uppercase tracking-widest text-xs">{{ i18nService.translate('RECORDS.LOADING_FIELDS') }}</p>
      </div>
    }
  }

  <!-- CONTENUTO SCHEDA: CRONOLOGIA -->
  @if (activeTab === 'history') {
    @if (recordId) {
      <div class="card-soft p-8">
        <app-record-history [entityKey]="entityKey" [recordId]="recordId"></app-record-history>
      </div>
    }
  }
</div>
