
<!-- Default view: Display selected IDs and an "Add" button -->
<div class="p-2 border border-surface rounded-md">
  <div class="flex flex-wrap gap-2">
    @for (id of selectedIds; track id) {
      <span class="flex items-center bg-base px-2 py-1 rounded-full text-sm">
        <code>{{ id }}</code>
        <button type="button" (click)="removeId(id)" class="ml-2 text-red-500 hover:text-red-700">&times;</button>
      </span>
    }
  </div>
  <button type="button" (click)="openSelectionModal()" class="button-secondary-sm mt-2">Add/Select Reference</button>
</div>

<!-- Modal template for selection -->
<ng-template #selectionModal>
  <div class="p-6 bg-surface">
    <h2 class="text-2xl font-bold text-[rgb(var(--color-primary))] mb-4">Select Records from '{{ entityKey }}'</h2>

    <div class="flex gap-2 mb-4">
      <select
        #searchFieldSelect
        (change)="onSearchFieldChange(searchFieldSelect.value)"
        class="input w-1/3">
        <option value="id">ID</option>
        @if(referencedEntityDef) {
          @for(field of referencedEntityDef.fields; track field.name) {
            @if(field.type === 'STRING' || field.type === 'EMAIL' || field.type === 'NUMBER') {
              <option [value]="field.name">{{ field.name }}</option>
            }
          }
        }
      </select>
      <input
        type="text"
        placeholder="Search..."
        class="input w-2/3"
        (input)="search($event.target.value)">
    </div>

    <div class="max-h-64 overflow-y-auto border border-base rounded-md">
      @if (availableRecords$ | async; as records) {
        @if (records.length > 0) {
          <ul>
            @for (record of records; track record.id) {
              <li
                class="p-2 flex items-center cursor-pointer hover:bg-base"
                (click)="toggleSelection(record.id)">
                <input
                  type="checkbox"
                  class="h-4 w-4 rounded border-surface text-[rgb(var(--color-primary))] focus:ring-[rgb(var(--color-primary))]"
                  [checked]="tempSelectedIds.includes(record.id)">
                <div class="ml-3 text-sm">
                  <p class="font-semibold">{{ record.id }}</p>
                  <p class="text-[rgb(var(--color-text))] opacity-70">
                    {{ record.data[(referencedEntityDef?.fields?.[0]?.name || '')] || '' }}
                  </p>
                </div>
              </li>
            }
          </ul>
        } @else {
          <p class="p-4 text-sm text-[rgb(var(--color-text))] opacity-70">No records found.</p>
        }
      }
    </div>

    <div class="flex justify-end space-x-4 pt-4 mt-4 border-t border-base">
      <button type="button" (click)="modalService.close()" class="button-secondary">Cancel</button>
      <button type="button" (click)="confirmSelection()" class="button-primary">Confirm Selection</button>
    </div>
  </div>
</ng-template>
