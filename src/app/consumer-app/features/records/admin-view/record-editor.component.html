@if (isAdmin$ | async) {
  <div class="container mx-auto p-4 max-w-6xl animate-soft-in">
    <!-- Titolo della Pagina -->
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
      <div>
        @if (entityDefinition) {
          <h1 class="text-3xl font-black text-[rgb(var(--color-primary))] uppercase tracking-tighter">
            {{ isEditMode ? i18nService.translate('RECORDS.EDIT_TITLE') : i18nService.translate('RECORDS.CREATE_TITLE') }} {{ entityDefinition.label }}
          </h1>
        }
        <p class="text-gray-500 text-[10px] font-black uppercase tracking-[0.2em] mt-1 opacity-60">{{ i18nService.translate('RECORDS.MANAGE_DATA') }} {{ entityKey }}</p>
      </div>
      
      <a [routerLink]="['/records', entityKey]" class="button-secondary self-start flex items-center gap-2">
        &larr; {{ i18nService.translate('COMMON.BACK_TO_LIST') }}
        <button type="button" (click)="$event.preventDefault(); i18nService.showFieldHelp('ACTION_CANCEL')" class="text-[rgb(var(--color-primary))] opacity-30 hover:opacity-100 text-[10px]">
          <i class="fa-solid fa-circle-info"></i>
        </button>
      </a>
    </div>

    <!-- Menu a Schede (Tabs) -->
    @if (isEditMode && entityDefinition && entityDefinition.historyEnabled) {
      <div class="flex border-b border-white/5 mb-8">
        <button (click)="setTab('data')" class="px-8 py-4 font-black uppercase text-xs tracking-widest transition-all" [class.text-[rgb(var(--color-primary))]]="activeTab === 'data'" [class.border-b-2]="activeTab === 'data'" [class.border-[rgb(var(--color-primary))]]="activeTab === 'data'" [class.text-gray-500]="activeTab !== 'data'">
          {{ i18nService.translate('RECORDS.CURRENT_DATA') }}
        </button>
        <button (click)="setTab('history')" class="px-8 py-4 font-black uppercase text-xs tracking-widest transition-all" [class.text-[rgb(var(--color-primary))]]="activeTab === 'history'" [class.border-b-2]="activeTab === 'history'" [class.border-[rgb(var(--color-primary))]]="activeTab === 'history'" [class.text-gray-500]="activeTab !== 'history'">
          {{ i18nService.translate('RECORDS.HISTORY') }}
        </button>
      </div>
    }

    <!-- CONTENUTO SCHEDA: DATI -->
    @if (activeTab === 'data') {
      @if (entityDefinition) {
        <form [formGroup]="editorForm" (ngSubmit)="onSubmit()" class="card-soft p-10">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
            @for (field of entityDefinition.fields; track field.name) {
              <div class="flex flex-col">
                <label [for]="field.name" class="label flex items-center justify-between gap-2">
                  <div class="flex items-center gap-1">
                    {{ field.name }}
                    @if (field.required) { <span class="text-red-500">*</span> }
                  </div>
                  <button type="button" (click)="i18nService.showFieldHelp('DATA_TYPE')" class="text-[rgb(var(--color-primary))] opacity-30 hover:opacity-100 text-[10px]">
                    <i class="fa-solid fa-circle-info"></i>
                  </button>
                </label>

                @switch (field.type) {
                  @case ('STRING') { <input [id]="field.name" [formControlName]="field.name" type="text" class="input" [placeholder]="field.name"> }
                  @case ('EMAIL') { <input [id]="field.name" [formControlName]="field.name" type="email" class="input" placeholder="esempio@mail.com"> }
                  @case ('NUMBER') { <input [id]="field.name" [formControlName]="field.name" type="number" class="input"> }
                  @case ('BOOLEAN') {
                    <div class="flex items-center h-12">
                      <input [id]="field.name" [formControlName]="field.name" type="checkbox" class="h-6 w-6 rounded-xl border-none bg-white/5 text-[rgb(var(--color-primary))] focus:ring-offset-0 focus:ring-[rgb(var(--color-primary))] cursor-pointer">
                      <span class="ml-3 text-sm text-gray-400 font-bold">{{ i18nService.translate('COMMON.ACTIVE') }}</span>
                    </div>
                  }
                  @case ('DATE') { <input [id]="field.name" [formControlName]="field.name" type="datetime-local" class="input"> }
                  @case ('ENUM') {
                    <select [id]="field.name" [formControlName]="field.name" class="input">
                      <option [ngValue]="null">{{ i18nService.translate('RECORDS.SELECT_VALUE') }}</option>
                      @for (enumValue of field.enumValues; track enumValue) { <option [value]="enumValue">{{ enumValue }}</option> }
                    </select>
                  }
                  @case ('REFERENCE') { <app-reference-search [formControlName]="field.name" [entityKey]="field.referenceEntityKey!"></app-reference-search> }
                }

                <div class="h-5 mt-1">
                  @if (hasError(field.name, 'required')) { <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">{{ i18nService.translate('RECORDS.REQUIRED_FIELD') }}</span> }
                  @if (hasError(field.name, 'email')) { <span class="text-[10px] font-bold text-red-500 uppercase tracking-widest">{{ i18nService.translate('RECORDS.INVALID_EMAIL') }}</span> }
                </div>
              </div>
            }
          </div>

          <div class="flex justify-end space-x-4 border-t border-white/5 pt-10 mt-10">
            <a [routerLink]="['/records', entityKey]" class="button-secondary px-8 flex items-center gap-2">
              {{ i18nService.translate('COMMON.CANCEL_SHORT') }}
              <button type="button" (click)="$event.preventDefault(); i18nService.showFieldHelp('ACTION_CANCEL')" class="text-[rgb(var(--color-primary))] opacity-30 hover:opacity-100 text-[10px]">
                <i class="fa-solid fa-circle-info"></i>
              </button>
            </a>
            <button type="submit" [disabled]="editorForm.invalid" class="button-primary px-12 flex items-center gap-3">
              {{ isEditMode ? i18nService.translate('COMMON.SAVE') : i18nService.translate('COMMON.CREATE') }}
              <button type="button" (click)="$event.stopPropagation(); i18nService.showFieldHelp('ACTION_SAVE')" class="text-black/30 hover:text-black text-[10px]">
                <i class="fa-solid fa-circle-info"></i>
              </button>
            </button>
          </div>
        </form>
      } @else {
        <div class="flex flex-col items-center justify-center py-32 card-soft border-dashed border-2 border-white/5">
          <div class="w-16 h-16 rounded-[2rem] border-4 border-white/10 border-t-[rgb(var(--color-primary))] animate-spin mb-6"></div>
          <p class="text-gray-500 font-black uppercase tracking-widest text-xs animate-pulse">{{ i18nService.translate('RECORDS.LOADING_FIELDS') }}</p>
        </div>
      }
    }

    <!-- CONTENUTO SCHEDA: CRONOLOGIA -->
    @if (activeTab === 'history') {
      @if (recordId) {
        <div class="card-soft p-10">
          <app-record-history [entityKey]="entityKey" [recordId]="recordId"></app-record-history>
        </div>
      }
    }
  </div>
} @else {
  <!-- MODALITÃ€ UTENTE: Editor Dinamico senza Schema Admin -->
  <app-consumer-record-editor [entityKey]="entityKey" [recordId]="recordId"></app-consumer-record-editor>
}
