openapi: 3.0.3
info:
  title: CMS NoSQL API
  description: |
    Backend configurabile per data entry dinamico.
    Definisci entità a runtime (come form), salva record in MongoDB, e cerca con DSL paginato.
    Autenticazione JWT con ACL per gruppi su ogni entity definition.
    Supporto gruppi utente, ruoli di sistema (SUPER_ADMIN, ADMIN) tramite gruppi e menu di navigazione configurabile.
  version: 1.0.0
  contact:
    name: WolfCoding

servers:
  - url: http://localhost:8088
    description: Sviluppo locale (profilo dev)

tags:
  - name: Auth
    description: Login, recupero password e cambio password
  - name: Entity Definitions
    description: CRUD definizioni entità (solo ruolo admin)
  - name: Records
    description: CRUD record e ricerca paginata (ACL per entità)
  - name: Files
    description: Upload, download e eliminazione file (autenticazione richiesta)
  - name: Email
    description: Invio email con allegati e gestione template (richiede ruolo di sistema ADMIN)
  - name: Groups
    description: CRUD gruppi (richiede ruolo admin)
  - name: Users
    description: CRUD utenti e reset password (richiede ruolo admin)
  - name: Menu
    description: Menu navigazione con visibilità per gruppi

security:
  - bearerAuth: []

paths:
  # ──────────────────────────────────────────────
  #  AUTH
  # ──────────────────────────────────────────────
  /api/v1/auth/login:
    post:
      tags: [Auth]
      summary: Login e generazione JWT
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              username: mario
              password: secret123
      responses:
        '200':
          description: Login riuscito
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              example:
                token: eyJhbGciOiJIUzI1NiJ9...
                username: mario
                groups: [editors]
                lastAccessAt: "2025-01-15T10:00:00Z"
                firstAccess: false
        '401':
          description: Credenziali non valide
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Account disabilitato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/recover-password:
    post:
      tags: [Auth]
      summary: Recupero password
      description: |
        Genera una nuova password casuale e la invia via email all'indirizzo registrato dell'utente.
        Il flag `firstAccess` viene reimpostato a `true`: l'utente dovra cambiare
        la password al prossimo accesso.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RecoverPasswordRequest'
            example:
              username: mario
      responses:
        '200':
          description: Nuova password inviata via email
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendEmailResponse'
              example:
                message: Nuova password inviata via email
                timestamp: "2025-01-15T10:30:00Z"
        '401':
          description: Utente non trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Account disabilitato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/auth/change-password:
    post:
      tags: [Auth]
      summary: Cambio password
      description: |
        Cambia la password dell'utente autenticato. Verifica la password corrente,
        imposta la nuova e setta `firstAccess` a `false`. Restituisce un nuovo JWT aggiornato.
        Richiede un token JWT valido nell'header Authorization.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChangePasswordRequest'
            example:
              oldPassword: passwordAutoGenerata
              newPassword: laMiaNuovaPassword123
      responses:
        '200':
          description: Password cambiata con successo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
              example:
                token: eyJhbGciOiJIUzI1NiJ9...
                username: mario
                groups: [editors]
                lastAccessAt: "2025-01-15T10:00:00Z"
                firstAccess: false
        '401':
          description: Password corrente errata o utente non trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ──────────────────────────────────────────────
  #  ENTITY DEFINITIONS
  # ──────────────────────────────────────────────
  /api/v1/entity-definitions:
    post:
      tags: [Entity Definitions]
      summary: Crea una definizione entità
      description: |
        Crea un nuovo tipo di entità con campi, regole di validazione e ACL.
        L'`entityKey` deve rispettare il pattern `^[a-z][a-z0-9_]{1,48}[a-z0-9]$`.
        Richiede ruolo **admin** (o **super_admin** tramite gerarchia ruoli).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEntityDefinitionRequest'
            examples:
              entita_base:
                summary: Entita con campi base
                value:
                  entityKey: customers
                  label: Clienti
                  fields:
                    - name: first_name
                      type: STRING
                      required: true
                      maxLen: 100
                    - name: email
                      type: EMAIL
                      required: true
                    - name: age
                      type: NUMBER
                      min: 0
                      max: 150
                    - name: role
                      type: ENUM
                      required: true
                      enumValues: [admin, user, guest]
                  acl:
                    read: [admin, user]
                    write: [admin]
                    delete: [admin]
                    search: [admin, user]
              entita_con_reference:
                summary: Entita con campo REFERENCE a un'altra entita
                description: |
                  Esempio di entity definition "assets" con un campo "assigned_to"
                  di tipo REFERENCE che referenzia record dell'entita "customers".
                  Il valore di un campo REFERENCE e sempre una lista di ID.
                  Al salvataggio di un record, il sistema verifica che ogni ID
                  nella lista esista effettivamente nella collection "customers".
                  Esempio di valore nel record: {"assigned_to": ["id_customer_1", "id_customer_2"]}
                value:
                  entityKey: assets
                  label: Asset aziendali
                  historyEnabled: true
                  fields:
                    - name: name
                      type: STRING
                      required: true
                      maxLen: 200
                    - name: serial_number
                      type: STRING
                      required: true
                      pattern: "^[A-Z0-9\\-]+$"
                    - name: purchase_date
                      type: DATE
                      required: true
                    - name: value
                      type: NUMBER
                      min: 0
                    - name: status
                      type: ENUM
                      required: true
                      enumValues: [active, maintenance, retired]
                    - name: assigned_to
                      type: REFERENCE
                      referenceEntityKey: customers
                  acl:
                    read: [admin, user]
                    write: [admin]
                    delete: [admin]
                    search: [admin, user]
      responses:
        '201':
          description: Definizione creata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EntityDefinitionResponse'
        '400':
          description: Entity key non valida o validazione fallita
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Entity key già esistente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags: [Entity Definitions]
      summary: Lista tutte le definizioni
      responses:
        '200':
          description: Lista definizioni
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/EntityDefinitionResponse'

  /api/v1/entity-definitions/{key}:
    parameters:
      - $ref: '#/components/parameters/EntityKey'

    get:
      tags: [Entity Definitions]
      summary: Dettaglio definizione
      responses:
        '200':
          description: Definizione trovata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EntityDefinitionResponse'
        '404':
          description: Definizione non trovata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags: [Entity Definitions]
      summary: Aggiorna definizione
      description: Aggiorna label, campi e ACL. L'entityKey non è modificabile.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateEntityDefinitionRequest'
      responses:
        '200':
          description: Definizione aggiornata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EntityDefinitionResponse'
        '404':
          description: Definizione non trovata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [Entity Definitions]
      summary: Elimina definizione
      description: Fallisce con 409 se esistono record associati.
      responses:
        '204':
          description: Eliminata
        '404':
          description: Non trovata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Esistono record associati
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ──────────────────────────────────────────────
  #  RECORDS
  # ──────────────────────────────────────────────
  /api/v1/records/{entityKey}:
    parameters:
      - $ref: '#/components/parameters/EntityKeyPath'

    post:
      tags: [Records]
      summary: Crea un record
      description: |
        Crea un record per l'entità specificata.
        I dati vengono validati contro la definizione (tipo, required, min/max, pattern, enum).
        Richiede permesso ACL **write** sull'entità.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRecordRequest'
            examples:
              record_base:
                summary: Record con campi base (entity "customers")
                value:
                  data:
                    first_name: Mario
                    email: mario@example.com
                    age: 35
                    role: admin
              record_con_reference:
                summary: Record con campo REFERENCE (entity "assets")
                description: |
                  Esempio di creazione record per l'entity "assets" che ha un campo
                  "assigned_to" di tipo REFERENCE verso "customers".
                  Il campo REFERENCE e sempre una lista di ID di record
                  esistenti nella collection referenziata.
                value:
                  data:
                    name: Laptop Dell XPS 15
                    serial_number: DELL-XPS-2025-001
                    purchase_date: "2025-03-15T00:00:00Z"
                    value: 1500
                    status: active
                    assigned_to:
                      - "66a1b2c3d4e5f600000001"
                      - "66a1b2c3d4e5f600000002"
      responses:
        '201':
          description: Record creato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecordResponse'
        '403':
          description: Permesso ACL negato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Entity definition non trovata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validazione dati fallita
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 422
                message: Record validation failed
                errors:
                  - field: email
                    message: Invalid email format
                  - field: age
                    message: "Value must be >= 0"
                timestamp: "2025-01-15T10:30:00Z"

  /api/v1/records/{entityKey}/{id}:
    parameters:
      - $ref: '#/components/parameters/EntityKeyPath'
      - $ref: '#/components/parameters/RecordId'

    get:
      tags: [Records]
      summary: Dettaglio record
      description: Richiede permesso ACL **read** sull'entità.
      responses:
        '200':
          description: Record trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecordResponse'
        '403':
          description: Permesso ACL negato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Record o entity non trovata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags: [Records]
      summary: Aggiorna record
      description: |
        Sostituzione completa del campo `data`.
        Richiede permesso ACL **write** sull'entità.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRecordRequest'
      responses:
        '200':
          description: Record aggiornato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecordResponse'
        '403':
          description: Permesso ACL negato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Non trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Validazione fallita
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [Records]
      summary: Elimina record
      description: Richiede permesso ACL **delete** sull'entità.
      responses:
        '204':
          description: Eliminato
        '403':
          description: Permesso ACL negato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Non trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/records/{entityKey}/search:
    parameters:
      - $ref: '#/components/parameters/EntityKeyPath'

    post:
      tags: [Records]
      summary: Ricerca paginata con filtri DSL
      description: |
        Ricerca record con filtri, ordinamento e paginazione.
        Richiede permesso ACL **search** sull'entità.

        **Limiti di sicurezza:**
        - Max 10 filtri per query
        - Max page size 100 (default 20)
        - Campi filtro/sort devono essere definiti nell'entità
        - Operatore `like` usa `Pattern.quote()` (escape metacaratteri regex)
        - Regex max 100 caratteri, no lookahead/lookbehind
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
            examples:
              filtro_semplice:
                summary: Filtro per ruolo
                value:
                  filters:
                    - field: role
                      op: eq
                      value: admin
                  page: 0
                  size: 10
              filtri_multipli:
                summary: Filtri multipli con ordinamento
                value:
                  filters:
                    - field: age
                      op: gte
                      value: 18
                    - field: role
                      op: in
                      value: [admin, user]
                  sorts:
                    - field: age
                      direction: desc
                  page: 0
                  size: 20
              ricerca_testuale:
                summary: Ricerca like (case-insensitive)
                value:
                  filters:
                    - field: first_name
                      op: like
                      value: mar
      responses:
        '200':
          description: Risultati paginati
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PageResponse'
        '400':
          description: Limiti superati o campo non definito
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Permesso ACL negato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Entity non trovata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/records/{entityKey}/{id}/history:
    parameters:
      - $ref: '#/components/parameters/EntityKeyPath'
      - $ref: '#/components/parameters/RecordId'
    get:
      tags: [Records]
      summary: Storico modifiche record
      description: Lista di tutte le versioni storicizzate del record. Richiede permesso ACL read.
      responses:
        '200':
          description: Lista versioni
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/RecordHistoryResponse'

  /api/v1/records/{entityKey}/{id}/history/{version}:
    parameters:
      - $ref: '#/components/parameters/EntityKeyPath'
      - $ref: '#/components/parameters/RecordId'
      - name: version
        in: path
        required: true
        schema:
          type: integer
    get:
      tags: [Records]
      summary: Dettaglio versione storica
      description: Recupera una versione specifica dello storico. Richiede permesso ACL read.
      responses:
        '200':
          description: Versione trovata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RecordHistoryResponse'
        '404':
          description: Versione non trovata

  # ──────────────────────────────────────────────
  #  FILES
  # ──────────────────────────────────────────────
  /api/v1/files:
    post:
      tags: [Files]
      summary: Carica un file
      description: |
        Carica un file nel sistema. Il file viene validato (dimensione, tipo MIME)
        e salvato nel backend di storage configurato (GridFS o S3).
        I metadati vengono registrati nella collection `file_metadata`.

        **Vincoli di validazione:**
        - Dimensione massima: 10 MB (configurabile)
        - Tipi MIME consentiti: image/jpeg, image/png, image/gif, application/pdf, text/plain (configurabile)
        - Il file non può essere vuoto
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: Il file da caricare
      responses:
        '201':
          description: File caricato con successo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FileUploadResponse'
              example:
                id: 6789abcdef012345
                filename: documento.pdf
                contentType: application/pdf
                size: 204800
                uploadedBy: mario
                createdAt: "2025-01-15T10:30:00Z"
        '400':
          description: File vuoto, troppo grande o tipo MIME non consentito
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                file_troppo_grande:
                  summary: File supera dimensione massima
                  value:
                    status: 400
                    message: "Il file supera la dimensione massima consentita: 10485760 byte"
                tipo_non_consentito:
                  summary: Tipo MIME non consentito
                  value:
                    status: 400
                    message: "Tipo di file non consentito: application/zip"
        '401':
          description: Token mancante o non valido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Errore di storage
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/files/{id}:
    parameters:
      - $ref: '#/components/parameters/FileId'

    get:
      tags: [Files]
      summary: Scarica un file
      description: |
        Restituisce il contenuto binario del file con gli header appropriati:
        `Content-Type`, `Content-Disposition` (attachment) e `Content-Length`.
      responses:
        '200':
          description: Contenuto del file
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
              example: 'attachment; filename="documento.pdf"'
            Content-Type:
              schema:
                type: string
              example: application/pdf
            Content-Length:
              schema:
                type: integer
              example: 204800
        '404':
          description: File non trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 404
                message: "File non trovato con id: 6789abcdef012345"
        '401':
          description: Token mancante o non valido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [Files]
      summary: Elimina un file
      description: |
        Esegue un'eliminazione logica (soft delete): marchia i metadati del file come eliminati
        (`deleted = true`) senza rimuovere il file fisico dal backend di storage (MongoDB GridFS o S3).
      responses:
        '204':
          description: File eliminato
        '404':
          description: File non trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Token mancante o non valido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ──────────────────────────────────────────────
  #  EMAIL
  # ──────────────────────────────────────────────
  /api/v1/email/send:
    post:
      tags: [Email]
      summary: Invia una email con template
      description: |
        Invia una email con corpo HTML risolto da un template e allegati opzionali.
        Il corpo HTML viene determinato dal template indicato tramite `templateId`,
        con i placeholder sostituiti dai valori forniti nella mappa `placeholders`.

        **Richiede ruolo di sistema `ADMIN`** (o `SUPER_ADMIN`).

        **Risoluzione template:**
        Se il `templateId` fornito non viene trovato nel database, il sistema cerca
        automaticamente `template/{templateId}.html` nel classpath. Se presente, viene usato
        come template (senza validazione bidirezionale dei placeholder).
        Se non esiste neanche nel classpath, viene restituito 404.

        **Sorgenti allegati:**
        - `attachments`: allegati Base64 inline (CID) o classici
        - `storageAttachments`: file dallo storage CMS, riferiti per `fileId`
        - Allegati del template: inclusi automaticamente come allegati classici

        **Evento calendario:**
        Se presente `calendarEvent`, viene generato un file `.ics` (RFC 5545) e allegato
        con content-type `text/calendar`. I client email lo riconoscono come invito calendario.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendEmailRequest'
            examples:
              email_semplice:
                summary: Email semplice con template
                value:
                  to: destinatario@example.com
                  subject: Conferma ordine
                  templateId: 6789abcdef012345
                  placeholders:
                    nome_cliente: Mario Rossi
                    numero_ordine: "1234"
                    totale: "99.90"
              email_con_allegati:
                summary: Email con allegati Base64 e da storage
                value:
                  to: destinatario@example.com
                  from: mittente@example.com
                  cc: [cc1@example.com]
                  subject: Documenti progetto
                  templateId: 6789abcdef012345
                  placeholders:
                    nome_cliente: Mario Rossi
                  attachments:
                    - filename: logo.png
                      contentType: image/png
                      base64Content: iVBORw0KGgoAAAANSUhEUgAA...
                      inline: true
                      contentId: logo1
                    - filename: contratto.pdf
                      contentType: application/pdf
                      base64Content: JVBERi0xLjQKJ...
                      inline: false
                  storageAttachments:
                    - fileId: 6789def012345
              email_con_calendario:
                summary: Email con evento calendario
                value:
                  to: destinatario@example.com
                  subject: Invito riunione
                  templateId: 6789abcdef012345
                  placeholders:
                    nome_cliente: Mario Rossi
                  calendarEvent:
                    summary: Riunione progetto CMS
                    description: Revisione sprint e pianificazione
                    location: Sala conferenze A
                    startDateTime: "2025-02-20T14:00:00Z"
                    endDateTime: "2025-02-20T15:30:00Z"
                    organizer: mittente@example.com
                    method: REQUEST
      responses:
        '200':
          description: Email inviata con successo
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SendEmailResponse'
              example:
                message: Email inviata con successo
                timestamp: "2025-01-15T10:30:00Z"
        '400':
          description: Validazione input fallita
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 400
                message: Validation failed
                errors:
                  - field: to
                    message: must not be blank
                  - field: templateId
                    message: must not be blank
        '401':
          description: Token mancante o non valido
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Ruolo admin mancante
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Template o file da storage non trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Errore durante l'invio della email
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                status: 500
                message: Email send error

  # ──────────────────────────────────────────────
  #  EMAIL TEMPLATES
  # ──────────────────────────────────────────────
  /api/v1/email/templates:
    post:
      tags: [Email]
      summary: Crea un template email
      description: |
        Crea un nuovo template HTML con placeholder nel formato `{{nome}}` e allegati opzionali.
        I nomi dei placeholder devono contenere solo lettere, numeri e underscore.
        Ogni placeholder dichiarato deve essere presente nel contenuto HTML.

        Gli allegati vengono salvati come documenti embedded nel template (Base64 in MongoDB).
        Quando il template viene usato per inviare un'email, gli allegati vengono inclusi
        automaticamente come allegati classici (non inline CID).

        **Richiede ruolo `admin`.**
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateEmailTemplateRequest'
            examples:
              template_semplice:
                summary: Template senza allegati
                value:
                  name: conferma_ordine
                  htmlContent: "<html><body><h1>Ordine {{numero_ordine}}</h1><p>Grazie {{nome_cliente}}!</p></body></html>"
                  placeholders: [numero_ordine, nome_cliente]
              template_con_allegati:
                summary: Template con allegato PDF
                value:
                  name: conferma_ordine
                  htmlContent: "<html><body><h1>Ordine {{numero_ordine}}</h1><p>Grazie {{nome_cliente}}!</p></body></html>"
                  placeholders: [numero_ordine, nome_cliente]
                  attachments:
                    - filename: termini_condizioni.pdf
                      contentType: application/pdf
                      base64Content: JVBERi0xLjQKJ...
      responses:
        '201':
          description: Template creato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmailTemplateResponse'
        '400':
          description: Placeholder non valido o non presente nell'HTML
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Nome template già esistente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags: [Email]
      summary: Lista tutti i template email
      responses:
        '200':
          description: Lista template
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/EmailTemplateResponse'

  /api/v1/email/templates/{id}:
    parameters:
      - $ref: '#/components/parameters/EmailTemplateId'

    get:
      tags: [Email]
      summary: Dettaglio template email
      responses:
        '200':
          description: Template trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EmailTemplateResponse'
        '404':
          description: Template non trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags: [Email]
      summary: Elimina template email
      responses:
        '204':
          description: Template eliminato
        '404':
          description: Template non trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ──────────────────────────────────────────────
  #  GROUPS
  # ──────────────────────────────────────────────
  /api/v1/groups:
    post:
      tags: [Groups]
      summary: Crea un nuovo gruppo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateGroupRequest'
      responses:
        '201':
          description: Gruppo creato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '409':
          description: Nome gruppo già esistente
    get:
      tags: [Groups]
      summary: Lista tutti i gruppi
      responses:
        '200':
          description: Lista gruppi
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GroupResponse'

  /api/v1/groups/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      tags: [Groups]
      summary: Dettaglio gruppo
      responses:
        '200':
          description: Gruppo trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '404':
          description: Gruppo non trovato
    put:
      tags: [Groups]
      summary: Aggiorna gruppo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateGroupRequest'
      responses:
        '200':
          description: Gruppo aggiornato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GroupResponse'
        '404':
          description: Gruppo non trovato
    delete:
      tags: [Groups]
      summary: Elimina gruppo
      responses:
        '204':
          description: Gruppo eliminato
        '404':
          description: Gruppo non trovato

  # ──────────────────────────────────────────────
  #  USERS
  # ──────────────────────────────────────────────
  /api/v1/users:
    post:
      tags: [Users]
      summary: Crea un nuovo utente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: Utente creato (password inviata via email)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '409':
          description: Username già esistente
    get:
      tags: [Users]
      summary: Lista tutti gli utenti
      responses:
        '200':
          description: Lista utenti
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserResponse'

  /api/v1/users/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      tags: [Users]
      summary: Dettaglio utente
      responses:
        '200':
          description: Utente trovato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '404':
          description: Utente non trovato
    put:
      tags: [Users]
      summary: Aggiorna utente
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateUserRequest'
      responses:
        '200':
          description: Utente aggiornato
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '404':
          description: Utente non trovato
    delete:
      tags: [Users]
      summary: Elimina utente
      responses:
        '204':
          description: Utente eliminato
        '404':
          description: Utente non trovato

  /api/v1/users/{id}/reset-password:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      tags: [Users]
      summary: Reset password utente
      responses:
        '204':
          description: Password resettata (inviata via email)
        '404':
          description: Utente non trovato

  # ──────────────────────────────────────────────
  #  MENU
  # ──────────────────────────────────────────────
  /api/v1/menu:
    get:
      tags: [Menu]
      summary: Menu filtrato per utente corrente
      description: Restituisce le voci di menu visibili in base ai gruppi dell'utente. Admin e super_admin vedono tutto.
      responses:
        '200':
          description: Menu utente
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MenuItemResponse'

  /api/v1/menu/manage:
    post:
      tags: [Menu]
      summary: Crea voce di menu
      description: Richiede ruolo admin.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateMenuItemRequest'
      responses:
        '201':
          description: Voce di menu creata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MenuItemResponse'
    get:
      tags: [Menu]
      summary: Lista tutte le voci di menu
      responses:
        '200':
          description: Lista voci di menu
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MenuItemResponse'

  /api/v1/menu/manage/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    put:
      tags: [Menu]
      summary: Aggiorna voce di menu
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateMenuItemRequest'
      responses:
        '200':
          description: Voce di menu aggiornata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MenuItemResponse'
        '404':
          description: Voce di menu non trovata
    delete:
      tags: [Menu]
      summary: Elimina voce di menu
      responses:
        '204':
          description: Voce di menu eliminata
        '404':
          description: Voce di menu non trovata

# ════════════════════════════════════════════════
#  COMPONENTS
# ════════════════════════════════════════════════
components:

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT ottenuto da `/api/v1/auth/login`.
        Il token contiene `sub` (username), `systemRoles` (lista ruoli di sistema) e `firstAccess` (boolean).
        Se `firstAccess` e `true`, tutte le API tranne `/api/v1/auth/**` rispondono con 403.

  parameters:
    EntityKey:
      name: key
      in: path
      required: true
      schema:
        type: string
        pattern: '^[a-z][a-z0-9_]{1,48}[a-z0-9]$'
      example: customers

    EntityKeyPath:
      name: entityKey
      in: path
      required: true
      schema:
        type: string
      example: customers

    RecordId:
      name: id
      in: path
      required: true
      schema:
        type: string
      example: 6789abcdef012345

    FileId:
      name: id
      in: path
      required: true
      description: Identificativo univoco del file
      schema:
        type: string
      example: 6789abcdef012345

    EmailTemplateId:
      name: id
      in: path
      required: true
      description: Identificativo univoco del template email
      schema:
        type: string
      example: 6789abcdef012345

  schemas:
    # ── Auth ──────────────────────────────────
    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          example: mario
        password:
          type: string
          format: password
          example: secret123

    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT token
          example: eyJhbGciOiJIUzI1NiJ9...
        username:
          type: string
          example: mario
        groups:
          type: array
          items:
            type: string
          description: Lista dei nomi dei gruppi dell'utente
        lastAccessAt:
          type: string
          format: date-time
          nullable: true
          description: Data dell'ultimo accesso riuscito
          example: "2025-01-15T10:00:00Z"
        firstAccess:
          type: boolean
          description: |
            `true` se l'utente deve cambiare la password al primo accesso.
            Tutte le API (tranne auth) sono bloccate finche `firstAccess` e `true`.
          example: false

    RecoverPasswordRequest:
      type: object
      required: [username]
      description: Richiesta di recupero password. La nuova password viene inviata via email.
      properties:
        username:
          type: string
          description: Nome utente per cui recuperare la password
          example: mario

    ChangePasswordRequest:
      type: object
      required: [oldPassword, newPassword]
      description: Richiesta di cambio password.
      properties:
        oldPassword:
          type: string
          format: password
          description: La password corrente dell'utente
          example: passwordAutoGenerata
        newPassword:
          type: string
          format: password
          minLength: 6
          maxLength: 100
          description: La nuova password (6-100 caratteri)
          example: laMiaNuovaPassword123

    # ── Entity Definition ─────────────────────
    FieldType:
      type: string
      enum: [STRING, NUMBER, BOOLEAN, DATE, EMAIL, ENUM, REFERENCE]

    FieldDefinitionDto:
      type: object
      required: [name, type]
      properties:
        name:
          type: string
          description: Nome del campo
          example: first_name
        type:
          $ref: '#/components/schemas/FieldType'
        required:
          type: boolean
          default: false
        min:
          type: number
          nullable: true
          description: Valore minimo (solo NUMBER)
        max:
          type: number
          nullable: true
          description: Valore massimo (solo NUMBER)
        maxLen:
          type: integer
          nullable: true
          description: Lunghezza massima (solo STRING)
        pattern:
          type: string
          nullable: true
          description: Pattern regex (solo STRING)
        enumValues:
          type: array
          items:
            type: string
          nullable: true
          description: Valori ammessi (solo ENUM)
          example: [active, inactive]
        referenceEntityKey:
          type: string
          nullable: true
          description: Chiave dell'entita referenziata (solo per campi di tipo REFERENCE)
          example: users

    AclDto:
      type: object
      nullable: true
      description: |
        Access Control List per gruppo. Ogni proprietà elenca i gruppi che hanno quel permesso.
        Se `null` o se una lista è vuota/assente, l'accesso è aperto a tutti gli utenti autenticati.
        Il ruolo `admin` ha sempre accesso completo indipendentemente dall'ACL.
      properties:
        read:
          type: array
          items:
            type: string
          description: Ruoli che possono leggere record (GET singolo)
          example: [admin, user]
        write:
          type: array
          items:
            type: string
          description: Ruoli che possono creare/aggiornare record (POST, PUT)
          example: [admin]
        delete:
          type: array
          items:
            type: string
          description: Ruoli che possono eliminare record (DELETE)
          example: [admin]
        search:
          type: array
          items:
            type: string
          description: Ruoli che possono cercare record (POST search)
          example: [admin, user]

    CreateEntityDefinitionRequest:
      type: object
      required: [entityKey, label, fields]
      properties:
        entityKey:
          type: string
          pattern: '^[a-z][a-z0-9_]{1,48}[a-z0-9]$'
          description: Identificativo unico dell'entità (immutabile)
          example: customers
        label:
          type: string
          description: Etichetta leggibile
          example: Clienti
        fields:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/FieldDefinitionDto'
        acl:
          $ref: '#/components/schemas/AclDto'
        historyEnabled:
          type: boolean
        notificationConfig:
          $ref: '#/components/schemas/NotificationConfigDto'

    UpdateEntityDefinitionRequest:
      type: object
      required: [label, fields]
      properties:
        label:
          type: string
          example: Clienti Premium
        fields:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/FieldDefinitionDto'
        acl:
          $ref: '#/components/schemas/AclDto'
        historyEnabled:
          type: boolean
        notificationConfig:
          $ref: '#/components/schemas/NotificationConfigDto'

    EntityDefinitionResponse:
      type: object
      properties:
        id:
          type: string
          example: 6789abcdef012345
        entityKey:
          type: string
          example: customers
        label:
          type: string
          example: Clienti
        fields:
          type: array
          items:
            $ref: '#/components/schemas/FieldDefinitionDto'
        acl:
          $ref: '#/components/schemas/AclDto'
        historyEnabled:
          type: boolean
        notificationConfig:
          $ref: '#/components/schemas/NotificationConfigDto'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    NotificationConfigDto:
      type: object
      description: |
        Configurazione opzionale delle notifiche email per gli eventi CRUD sui record.
        Se omessa, nessuna email viene inviata. I templateId nulli disabilitano la notifica
        per il relativo evento. Le notifiche vengono inviate DOPO il completamento dell'operazione.
      required: [to]
      properties:
        to:
          type: array
          minItems: 1
          items:
            type: string
          description: |
            Lista dei destinatari. Accetta indirizzi fissi ("admin@azienda.it")
            e placeholder dinamici ("{{email}}") risolti dai dati del record.
          example: ["admin@azienda.it", "{{email}}"]
        subject:
          type: string
          nullable: true
          description: |
            Oggetto dell'email. Supporta placeholder {{chiave}}.
            Se omesso usa "[CMS] Notifica <entityKey>".
          example: "Nuovo ordine {{id}} per {{entityKey}}"
        createTemplateId:
          type: string
          nullable: true
          description: ID del template email per le notifiche di creazione. null = nessuna notifica.
          example: notifica-creazione
        updateTemplateId:
          type: string
          nullable: true
          description: ID del template email per le notifiche di aggiornamento. null = nessuna notifica.
          example: notifica-aggiornamento
        deleteTemplateId:
          type: string
          nullable: true
          description: ID del template email per le notifiche di eliminazione. null = nessuna notifica.
          example: null

    # ── Records ───────────────────────────────
    CreateRecordRequest:
      type: object
      required: [data]
      properties:
        data:
          type: object
          additionalProperties: true
          description: |
            Mappa chiave-valore dei dati. Le chiavi devono corrispondere
            ai nomi dei campi definiti nella entity definition.

    UpdateRecordRequest:
      type: object
      required: [data]
      properties:
        data:
          type: object
          additionalProperties: true

    RecordResponse:
      type: object
      properties:
        id:
          type: string
          example: 6789abcdef012345
        entityKey:
          type: string
          example: customers
        data:
          type: object
          additionalProperties: true
          example:
            first_name: Mario
            email: mario@example.com
            age: 35
            role: admin
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    RecordHistoryResponse:
      type: object
      properties:
        id:
          type: string
        recordId:
          type: string
        entityKey:
          type: string
        data:
          type: object
          additionalProperties: true
        version:
          type: integer
        modifiedBy:
          type: string
        modifiedAt:
          type: string
          format: date-time

    # ── Query DSL ─────────────────────────────
    FilterOperator:
      type: string
      enum: [eq, ne, gt, gte, lt, lte, in, like]
      description: |
        - `eq` — uguale
        - `ne` — diverso
        - `gt` / `gte` — maggiore / maggiore o uguale
        - `lt` / `lte` — minore / minore o uguale
        - `in` — contenuto in lista (value deve essere un array)
        - `like` — contiene, case-insensitive (value deve essere stringa, metacaratteri regex escapati)

    FilterRequest:
      type: object
      required: [field, op, value]
      properties:
        field:
          type: string
          description: Nome del campo (deve essere definito nell'entità)
          example: age
        op:
          $ref: '#/components/schemas/FilterOperator'
        value:
          description: Valore di confronto (tipo dipende dall'operatore)
          example: 18

    SortRequest:
      type: object
      required: [field]
      properties:
        field:
          type: string
          description: Campo di ordinamento (deve essere definito nell'entità)
          example: age
        direction:
          type: string
          enum: [asc, desc]
          default: asc
          example: desc

    SearchRequest:
      type: object
      properties:
        filters:
          type: array
          maxItems: 10
          items:
            $ref: '#/components/schemas/FilterRequest'
        sorts:
          type: array
          items:
            $ref: '#/components/schemas/SortRequest'
        page:
          type: integer
          minimum: 0
          default: 0
          description: Numero di pagina (0-based)
        size:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Elementi per pagina

    PageResponse:
      type: object
      properties:
        content:
          type: array
          items:
            $ref: '#/components/schemas/RecordResponse'
        page:
          type: integer
          example: 0
        size:
          type: integer
          example: 20
        totalElements:
          type: integer
          format: int64
          example: 42
        totalPages:
          type: integer
          example: 3

    # ── Email ────────────────────────────────
    SendEmailRequest:
      type: object
      required: [to, subject, templateId]
      description: |
        Richiesta invio email. Il corpo HTML viene risolto dal template indicato
        tramite `templateId`, con i placeholder sostituiti dai valori forniti.
        Gli allegati possono provenire da tre sorgenti: Base64 (`attachments`),
        storage CMS (`storageAttachments`), e allegati del template (automatici).
      properties:
        to:
          type: string
          description: Indirizzo email del destinatario
          example: destinatario@example.com
        from:
          type: string
          nullable: true
          description: Indirizzo mittente (usa default da configurazione se omesso)
          example: mittente@example.com
        cc:
          type: array
          nullable: true
          items:
            type: string
          description: Indirizzi in copia conoscenza
          example: [cc1@example.com]
        bcc:
          type: array
          nullable: true
          items:
            type: string
          description: Indirizzi in copia conoscenza nascosta
          example: [bcc@example.com]
        subject:
          type: string
          description: Oggetto della email
          example: Conferma ordine
        templateId:
          type: string
          description: ID del template email da utilizzare
          example: 6789abcdef012345
        placeholders:
          type: object
          nullable: true
          additionalProperties:
            type: string
          description: |
            Mappa chiave-valore dei placeholder da sostituire nel template.
            I valori vengono HTML-escaped.
          example:
            nome: Mario Rossi
            azienda: WolfCoding
        attachments:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/AttachmentDto'
          description: Lista di allegati in Base64 (inline CID o classici)
        storageAttachments:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/StorageAttachmentDto'
          description: Lista di allegati referenziati dallo storage CMS
        calendarEvent:
          $ref: '#/components/schemas/CalendarEventDto'

    AttachmentDto:
      type: object
      required: [filename, contentType, base64Content]
      properties:
        filename:
          type: string
          description: Nome del file
          example: logo.png
        contentType:
          type: string
          description: Tipo MIME del file
          example: image/png
        base64Content:
          type: string
          description: Contenuto del file codificato in Base64
          example: iVBORw0KGgoAAAANSUhEUgAA...
        inline:
          type: boolean
          default: false
          description: |
            `true` = embedding inline CID (per immagini nell'HTML, referenziabili con `<img src="cid:contentId">`).
            `false` = allegato classico.
        contentId:
          type: string
          nullable: true
          description: |
            Identificativo CID per il riferimento nell'HTML.
            Es. `logo1` per `<img src="cid:logo1">`. Richiesto se `inline=true`.
          example: logo1

    SendEmailResponse:
      type: object
      properties:
        message:
          type: string
          description: Messaggio di conferma
          example: Email inviata con successo
        timestamp:
          type: string
          format: date-time
          description: Data e ora dell'invio

    StorageAttachmentDto:
      type: object
      required: [fileId]
      description: |
        Allegato email referenziato dallo storage CMS. Il file viene recuperato
        tramite il suo ID e filename/contentType vengono derivati dai metadati.
      properties:
        fileId:
          type: string
          description: ID del file nello storage CMS (corrisponde a FileMetadata.id)
          example: 6789abcdef012345

    CalendarEventDto:
      type: object
      required: [summary, startDateTime, endDateTime]
      description: |
        Evento calendario iCal (RFC 5545) da allegare all'email.
        Viene generato un file `.ics` e allegato con content-type `text/calendar`.
        I client email lo riconoscono automaticamente come invito calendario.
      properties:
        summary:
          type: string
          description: Titolo dell'evento
          example: Riunione progetto CMS
        description:
          type: string
          nullable: true
          description: Descrizione dell'evento
          example: Revisione sprint e pianificazione
        location:
          type: string
          nullable: true
          description: Luogo dell'evento
          example: Sala conferenze A
        startDateTime:
          type: string
          format: date-time
          description: Data e ora di inizio in UTC
          example: "2025-02-20T14:00:00Z"
        endDateTime:
          type: string
          format: date-time
          description: Data e ora di fine in UTC
          example: "2025-02-20T15:30:00Z"
        organizer:
          type: string
          nullable: true
          description: Indirizzo email dell'organizzatore
          example: organizer@example.com
        method:
          type: string
          nullable: true
          description: |
            Metodo iCal: `REQUEST` (invito, default) o `PUBLISH` (pubblicazione).
          default: REQUEST
          example: REQUEST

    TemplateAttachmentDto:
      type: object
      required: [filename, contentType, base64Content]
      description: |
        Allegato associato a un template email. Salvato come documento embedded
        nel template su MongoDB. Quando il template viene usato, questi allegati
        vengono inclusi automaticamente come allegati classici (non inline CID).
      properties:
        filename:
          type: string
          description: Nome del file
          example: termini_condizioni.pdf
        contentType:
          type: string
          description: Tipo MIME del file
          example: application/pdf
        base64Content:
          type: string
          description: Contenuto del file codificato in Base64
          example: JVBERi0xLjQKJ...

    CreateEmailTemplateRequest:
      type: object
      required: [name, htmlContent, placeholders]
      properties:
        name:
          type: string
          description: Nome identificativo del template (univoco)
          example: benvenuto
        htmlContent:
          type: string
          description: |
            Contenuto HTML del template con placeholder nel formato `{{nome_placeholder}}`.
          example: "<html><body><h1>Ciao {{nome}}!</h1><p>Benvenuto in {{azienda}}.</p></body></html>"
        placeholders:
          type: array
          items:
            type: string
          description: |
            Lista dei nomi dei placeholder presenti nel template.
            Devono corrispondere ai token `{{...}}` nel contenuto HTML.
            Solo lettere, numeri e underscore consentiti.
          example: [nome, azienda]
        attachments:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/TemplateAttachmentDto'
          description: |
            Lista di allegati da associare al template.
            Vengono inclusi come allegati classici ogni volta che il template viene usato.

    EmailTemplateResponse:
      type: object
      properties:
        id:
          type: string
          description: Identificativo univoco del template
          example: 6789abcdef012345
        name:
          type: string
          description: Nome identificativo del template
          example: benvenuto
        htmlContent:
          type: string
          description: Contenuto HTML con placeholder
          example: "<html><body><h1>Ciao {{nome}}!</h1><p>Benvenuto in {{azienda}}.</p></body></html>"
        placeholders:
          type: array
          items:
            type: string
          description: Lista dei placeholder definiti
          example: [nome, azienda]
        attachments:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/TemplateAttachmentDto'
          description: Lista degli allegati associati al template
        createdBy:
          type: string
          description: Username dell'utente che ha creato il template
          example: mario
        createdAt:
          type: string
          format: date-time
          description: Data e ora di creazione
        updatedAt:
          type: string
          format: date-time
          description: Data e ora dell'ultimo aggiornamento

    # ── Files ────────────────────────────────
    FileUploadResponse:
      type: object
      properties:
        id:
          type: string
          description: Identificativo univoco del file
          example: 6789abcdef012345
        filename:
          type: string
          description: Nome originale del file
          example: documento.pdf
        contentType:
          type: string
          description: Tipo MIME del file
          example: application/pdf
        size:
          type: integer
          format: int64
          description: Dimensione del file in byte
          example: 204800
        uploadedBy:
          type: string
          description: Username dell'utente che ha caricato il file
          example: mario
        createdAt:
          type: string
          format: date-time
          description: Data e ora del caricamento

    # ── Groups ───────────────────────────────
    CreateGroupRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 50
        description:
          type: string
        systemRole:
          type: string
          nullable: true
          enum: [SUPER_ADMIN, ADMIN]

    UpdateGroupRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 50
        description:
          type: string
        systemRole:
          type: string
          nullable: true
          enum: [SUPER_ADMIN, ADMIN]

    GroupResponse:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        systemRole:
          type: string
          nullable: true
          enum: [SUPER_ADMIN, ADMIN]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ── Users ────────────────────────────────
    CreateUserRequest:
      type: object
      required: [username, email]
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 50
        email:
          type: string
          format: email
        groupIds:
          type: array
          items:
            type: string

    UpdateUserRequest:
      type: object
      properties:
        email:
          type: string
          format: email
        groupIds:
          type: array
          items:
            type: string
        enabled:
          type: boolean

    UserResponse:
      type: object
      properties:
        id:
          type: string
        username:
          type: string
        email:
          type: string
          format: email
        groupIds:
          type: array
          items:
            type: string
        groupNames:
          type: array
          items:
            type: string
        enabled:
          type: boolean
        firstAccess:
          type: boolean
        lastAccessAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time

    # ── Menu ─────────────────────────────────
    CreateMenuItemRequest:
      type: object
      required: [label]
      properties:
        label:
          type: string
          minLength: 1
          maxLength: 100
        entityKey:
          type: string
        icon:
          type: string
        position:
          type: integer
        parentId:
          type: string
        groups:
          type: array
          items:
            type: string

    UpdateMenuItemRequest:
      type: object
      required: [label]
      properties:
        label:
          type: string
          minLength: 1
          maxLength: 100
        entityKey:
          type: string
        icon:
          type: string
        position:
          type: integer
        parentId:
          type: string
        groups:
          type: array
          items:
            type: string

    MenuItemResponse:
      type: object
      properties:
        id:
          type: string
        label:
          type: string
        entityKey:
          type: string
        icon:
          type: string
        position:
          type: integer
        parentId:
          type: string
        groups:
          type: array
          items:
            type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    # ── Errori ────────────────────────────────
    ValidationErrorDetail:
      type: object
      properties:
        field:
          type: string
          example: email
        message:
          type: string
          example: Invalid email format

    ErrorResponse:
      type: object
      properties:
        status:
          type: integer
          example: 400
        message:
          type: string
          example: Validation failed
        errors:
          type: array
          nullable: true
          items:
            $ref: '#/components/schemas/ValidationErrorDetail'
        timestamp:
          type: string
          format: date-time
